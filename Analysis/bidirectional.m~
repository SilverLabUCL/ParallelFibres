% This script plots the correlations of individual PFs with behaviour to
% show bidirectionality of responses

clear all; clc

define_dirs;
        
C_speed = cell(8,1); p_speed = cell(8,1);
C_angle = cell(8,1); p_angle = cell(8,1);
C_setpoint = cell(8,1); p_setpoint = cell(8,1); 
C_amplitude = cell(8,1); p_amplitude = cell(8,1);

for dataset_ix =  1:8
    
    % Load data
    [dFF,acquisition_rate] = load_data(dataset_ix);
    
    % Load behavioural data
    [whisk_angle,whisk_set_point,whisk_amp,speed] = load_behav_data(dataset_ix,time);
    
    C_speed_temp = zeros(N,1); p_speed_temp = [];
    C_angle_temp = []; p_angle_temp = [];
    C_setpoint_temp = []; p_setpoint_temp = []; 
    C_amplitude_temp = []; p_amplitude_temp = [];

    for n = 1:size(dFF,1)
        [C_speed_temp(n),p_speed_temp(n)] = corr_sig(x,y,acquisition_rate);
    end
    
    C_all_speed = [C_all_speed;C_speed];
    C_all_mi = [C_all_mi;C_mi];
    
end

%%
bins = linspace(-1,1,30);
bins_c = bins(2:end)-mean(diff(bins))/2;
h = histogram(C_pass_shuff_speed,bins);
h_pass_speed = h.Values;
h = histogram(C_fail_shuff_speed,bins);
h_fail_speed = h.Values;

h = histogram(C_pass_shuff_mi,bins);
h_pass_mi = h.Values;
h = histogram(C_fail_shuff_mi,bins);
h_fail_mi = h.Values;

figure, bar(bins_c,h_fail_mi,'FaceColor',[.6,.8,1],'EdgeColor','w')
hold on, bar(bins_c,h_pass_mi,'FaceColor','b','EdgeColor','w')

figure, bar(bins_c,h_fail_speed,'FaceColor',[1,.8,.8],'EdgeColor','w')
hold on, bar(bins_c,h_pass_speed,'FaceColor','r','EdgeColor','w')

%% Plot dFF

figure, hold on
for k = 1:Nf
    plot(TimeAxon(:,k),Axon_dFF_smooth(:,k)+k,'k')
end

%% With lag, no shuffle

C_mi_max = [];

for dataset_ix =  1:7
    dataset_ix
    load(strcat('for_Alex/',dataset_ixs_Crus1_patches{dataset_ix})) % 1,2,4,5,6

    if dataset_ix ~=2
        load(strcat('correct_baseline_',int2str(dataset_ix),'.mat'))
    end

    [T,N] = size(Axon_dFF);
    
    Axon_dFF_ = zeros(size(Axon_dFF));
    Axon_dFF_s_ = zeros(size(Axon_dFF));
    for k = 1:size(Axon_dFF,2)
        t= TimeAxon(:,k);
        if dataset_ix ~=2
            Axon_dFF_(:,k) = Axon_dFF(:,k)-(f.a*exp(f.b*t)+f.c*exp(f.d*t));
        else
            Axon_dFF_(:,k) = Axon_dFF(:,k);
        end
        Axon_dFF_s_(:,k) = smoothdata(Axon_dFF_(:,k),'gaussian',round(200*acquisition_rate/1000));
    end
    Axon_dFF =Axon_dFF_;
    Axon_dFF_smooth =Axon_dFF_s_;
    clear Axon_dFF_
    clear Axon_dFF_s_

    dt_MI = mean(diff(MI_facepad(:,2)));
    MI_smooth = smoothdata(MI_facepad(:,1),'gaussian',round(200/dt_MI));
    MI_interp = interp1(MI_facepad(:,2),MI_smooth,TimeAxon(:,end));

    dt_speed = mean(diff(SpeedTimeMatrix));
    Speed_smooth = smoothdata(SpeedDataMatrix,'gaussian',round(200/dt_speed));
    Speed_interp = interp1(SpeedTimeMatrix,Speed_smooth,TimeAxon(:,end));


    x = diff(mean(TimeAxon,2)); trial_switch = find(abs(x-median(x))>.01);
    if numel(trial_switch)~=29
        error
    end
    
    
    
    C_mi = zeros(N, 2*(T/30)-1); C_speed = zeros(N, 2*(T/30)-1);
    
    for n = 1:N
        temp_mi = zeros(30,2*(T/30)-1);
        temp_speed = zeros(30,2*(T/30)-1);
        
        for tr = 1:30
            if tr==1
                ix_trial = 1:trial_switch(1);
            elseif tr == 30
                ix_trial = trial_switch(end)+1:T;
            else
                ix_trial = trial_switch(tr-1)+1:trial_switch(tr);
            end
            [temp_mi(tr,:), lag] = xcov(MI_interp(ix_trial),Axon_dFF_smooth(ix_trial,n),'coeff');
            [temp_speed(tr,:), lag_speed] = xcov(Speed_interp(ix_trial),Axon_dFF_smooth(ix_trial,n),'coeff');
            if norm(lag-lag_speed)~=0
                error
            end
        end

        C_mi(n,:) = mean(temp_mi,1);

        C_speed(n,:) = mean(temp_speed,1);
        
        [max_val,b] = max(abs(C_mi(n,:)));
        if max_val > 3*std(C_mi(n,:)) %abs(lag(b))/acquisition_rate < 1 & max_val > 3*std(C_mi(n,:))
            C_mi_max = [C_mi_max; (lag(b) + rand - 0.5 )/acquisition_rate, C_mi(n,b)];
            if max_val > 4*std(C_mi(n,:)) & abs(lag(b))/acquisition_rate > .1 & max_val > .4%.8 & C_mi(n,b)<0
                error
            end
        end
    end
    
    %figure, plot(lag/acquisition_rate,C_mi)
    %xlabel('Lag (s)'); ylabel('Correlation with WMI')
    %title(dataset_ix)
    
    
end

%figure, histogram(C_all)
