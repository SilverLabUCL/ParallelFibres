# ROI Grouping

## Summary
This folder contains scripts used for signal extraction and grouping varicosities into putative axons. Light data preprocessing (e.g., offline movement correction) was performed prior to the scripts here. The folder `Utilities/` includes additional helper functions.

## Data requirements
This code requires, for each experiment, a file containing the following variables:

* `aquisition_rate` is a scalar describing the acquisition rate in Hz.
* `Pixel_size` is a scalar describing the size of each pixel in microns.
* `Numb_frames` is a scalar describing the number of timepoints in the experiment.
* `Numb_patches` is a scalar describing the number of patches in the experiment.
* `Numb_trials` is a scalar describing the number of trials.
* `Numb_cycle` is the number of cycles.
* `Time_between_trial` is a vector of intertrial times.
* `MatrixTime` is a matrix containing the time it takes to reach the corresponding pixel in a cycle.
* `MatrixTime_patch` contains the same information as `MatrixTime` in a cell organized by patch.
* `patches` is a cell of length `Numb_patches` containing the fluorescence data for each patch. Each element of the cell contains a 3-dimensional data array of size d1 x d2 x `Numb_frames`, where d1 and d2 are the dimensions of each patch.
* `dlc_whisk_angle` and `dlc_whisk_time` are vectors containing the whisking angle time series and times as determined via DeepLabCut.
* `Patch_coordinates` is a structure containing coordinate information about each patch. `Patch_coordinates.data` is a matrix in which each row represents a patch, and columns 5, 6, and 7 represent the X, Y, and Z positions (respectively) of that patch.
* `SpeedDataMatrix` and `SpeedTimeMatrix` are vectors containing the wheel speed time series and times from the wheel encoder.
* `wheel_MI` is a matrix whose second column contains the wheel motion index time series as determined from the wheel cameras and whose second column contains the corresponding times.

The function `convert_data_format.m` converts the data in this file into separate files used throughout the analysis.

An additional csv file is required for grouping (`Axon_IDs.csv`). This is a file generated from ImageJ when tracing small axon segments in the structural data (Z stacks) using the multipoint tool. The 6th and 7th columns contain the X and Y position of each point. Each pair of rows gives the start point and end point of the traced axon segment, and columns 5 and 6 give x and y. See `calc_fibre_direction.m` for more details.

## Overview of scripts

`convert_data_format.m` converts original .mat file of a particular experiment (described above) into separate files for behavioural data, metadata, and functional data (separate file per patch).

`calc_fibre_direction.m` calculates the average fiber direction in each patch. Requires individual small parallel fibre segments to have been hand-traced from Z stacks in ImageJ. This information is used for Criterion 1 of the grouping procedure.

`calc_distrib_Cn.m` plots the distribution of values of the correlation image to find a threshold for ROI detection when identifying ROIs (candidate varicosities).

`plot_distrib_SNRs.m` calculates the threshold SNR for ROI rejection (set to 95th percentile of SNRs of spurious ROIs in the neuropil).

`plot_distrib_corr.m` calculates the distribution of correlations between ROIs within or across patches. This is used to calculate a threshold for the grouping procedure (Criterion 2). Requires a .mat file generated by `plot_distrib_SNRs.m`. 

`group_rois_auto.m` performs the grouping of ROIs into putative axons. This requires .mat files generated by `calc_fibre_direction.m`, `plot_distrib_SNRs.m`,and `plot_distrib_corr.m`.

`plot_spatial_info.m` plots the distribution of intervaricosity distances on the same putative fibre, generating Figure 1d.

`analyze_neuropil.m` compares ROI fluroescence (signal) to neuropil, generating Supplementary Figure 4.

## Dependency on CNMF

Much of the early processing stages of the ROI grouping code was inspired by [CNMF](https://www.sciencedirect.com/science/article/pii/S0896627315010843). This includes some functions which have been adapted heavily for our data (e.g., `detect_ROIs.m` in `Utilities/`), as well as a few functions (in the folder `From CNMF_E/`) which are borrowed directly from their [GitHub](https://github.com/zhoupc/CNMF_E). If you use these tools, please cite the original authors:

Zhou, P., Resendez, S.L., Rodriguez-Romaguera, J., Jimenez, J.C, Neufeld, S.Q., Giovannucci, A., Friedrich, J., Pnevmatikakis, E.A., Stuber, Garret D , Stuber, G.D., Hen, R., Kheirbek, M.A., Sabatini, B.L., Kass, R.E., Paninski, L. (2018). Efficient and accurate extraction of in vivo calcium signals from microendoscopic video data. eLife, pp.e28728. 
