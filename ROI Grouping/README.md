# ROI Grouping

## Summary
This folder contains scripts used for signal extraction and grouping varicosities into putative axons. Light data preprocessing (e.g., offline movement correction) was performed prior to the scripts here. The folder `Utilities/` includes additional helper functions.

## Overview of scripts

`convert_data_format.m` converts original .mat file of a particular experiment into separate files for behavioural data, metadata, and functional data (separate file per patch).

`calc_fibre_direction.m` calculates the average fiber direction in each patch. Requires individual small parallel fibre segments to have been hand-traced from Z stacks in ImageJ. This information is used for Criterion 1 of the grouping procedure.

`calc_distrib_Cn.m` plots the distribution of values of the correlation image to find a threshold for ROI detection when identifying ROIs (candidate varicosities).

`plot_distrib_SNRs.m` calculates the threshold SNR for ROI rejection (set to 95th percentile of SNRs of spurious ROIs in the neuropil).

`plot_distrib_corr.m` calculates the distribution of correlations between ROIs within or across patches. This is used to calculate a threshold for the grouping procedure (Criterion 2). Requires a .mat file generated by `plot_distrib_SNRs.m`. 

`group_rois_auto.m` performs the grouping of ROIs into putative axons. This requires .mat files generated by `calc_fibre_direction.m`, `plot_distrib_SNRs.m`,and `plot_distrib_corr.m`.

`plot_spatial_info.m` plots the distribution of intervaricosity distances on the same putative fibre, generating Figure 1d.

`analyze_neuropil.m` compares ROI fluroescence (signal) to neuropil, generating Supplementary Figure 4.

## Dependency on CNMF

Much of the early processing stages of the ROI grouping code was inspired by [CNMF](https://www.sciencedirect.com/science/article/pii/S0896627315010843). This includes some functions which have been adapted heavily for our data (e.g., `detect_ROIs.m` in `Utilities/`), as well as a few functions (in the folder `From CNMF_E/`) which are borrowed directly from their [GitHub](https://github.com/zhoupc/CNMF_E). If you use these tools, please cite the original authors:

Zhou, P., Resendez, S.L., Rodriguez-Romaguera, J., Jimenez, J.C, Neufeld, S.Q., Giovannucci, A., Friedrich, J., Pnevmatikakis, E.A., Stuber, Garret D , Stuber, G.D., Hen, R., Kheirbek, M.A., Sabatini, B.L., Kass, R.E., Paninski, L. (2018). Efficient and accurate extraction of in vivo calcium signals from microendoscopic video data. eLife, pp.e28728. 
